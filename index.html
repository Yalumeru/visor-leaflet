<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa Leaflet con GeoJSON</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    .legend, .filters-control {
      background: white;
      padding: 6px 8px;
      font: 12px/14px Arial, Helvetica, sans-serif;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      border-radius: 4px;
    }
    .legend strong {
      display: block;
      margin-bottom: 4px;
    }
    .legend i {
      width: 12px;
      height: 12px;
      float: left;
      margin-right: 6px;
      opacity: 0.8;
    }
    .filters-control label {
      display: block;
      margin-bottom: 4px;
    }
    .filters-control select {
      width: 150px;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // =============================
    //  CONFIGURA ESTOS NOMBRES üî¥
    // =============================
    // Cambia "DPTO" y "MUNICIPIO" por los nombres REALES
    // de los campos en tu GeoJSON (respeta may√∫sculas/min√∫sculas)
    const FIELD_DEPTO = "DPTO";
    const FIELD_MPIO  = "MUNICIPIO";

    // --- Mapas base ---
    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    });

    // üîß Corregido: Esri usa {z}/{y}/{x}
    var esriSat = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      {
        maxZoom: 19,
        attribution: 'Tiles &copy; Esri'
      }
    );

    var cartoLight = L.tileLayer(
      'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
      {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap &copy; CARTO'
      }
    );

    // Crear mapa centrado en Colombia con OSM por defecto
    var map = L.map('map', {
      center: [4.5, -74.1],
      zoom: 6,
      layers: [osm]
    });

    var baseLayers = {
      "OSM est√°ndar": osm,
      "Esri Sat√©lite": esriSat,
      "Carto claro": cartoLight
    };

    var overlays = {};
    var layerControl = L.control.layers(baseLayers, overlays, {
      collapsed: false
    }).addTo(map);

    // Capa de ZRC como LayerGroup (para poder vaciar/llenar con filtros)
    var zrcLayer = L.layerGroup().addTo(map);
    layerControl.addOverlay(zrcLayer, "ZRC constituidas");

    // ==================================
    //  Control de filtros (dpto / mpio)
    // ==================================
    var filtersControl = L.control({ position: 'topleft' });

    filtersControl.onAdd = function(map) {
      var div = L.DomUtil.create('div', 'filters-control');
      div.innerHTML =
        '<strong>Filtros</strong>' +
        '<label>Departamento:<br>' +
        '<select id="filtro-depto">' +
        '<option value="__todos__">(Todos)</option>' +
        '</select></label>' +
        '<label>Municipio:<br>' +
        '<select id="filtro-mpio">' +
        '<option value="__todos__">(Todos)</option>' +
        '</select></label>';

      // Evita que al hacer scroll/click sobre el control se mueva el mapa
      L.DomEvent.disableClickPropagation(div);
      return div;
    };

    filtersControl.addTo(map);

    var deptoSelect = null;
    var mpioSelect  = null;

    // =================
    //  Leyenda din√°mica
    // =================
    var legend = L.control({ position: 'bottomright' });

    legend.onAdd = function(map) {
      var div = L.DomUtil.create('div', 'legend');
      legend._div = div; // guardamos referencia
      updateLegend();
      return div;
    };

    legend.addTo(map);

    function updateLegend() {
      if (!legend._div) return;

      var html = "";

      // Solo mostramos leyenda si la capa est√° encendida y tiene features
      if (map.hasLayer(zrcLayer) && zrcLayer.getLayers().length > 0) {
        html += '<strong>Leyenda</strong><br>';
        html += '<i style="background:#fb9a99; border:2px solid #e31a1c;"></i> ZRC constituidas<br>';
      }

      legend._div.innerHTML = html;
      legend._div.style.display = html ? 'block' : 'none';
    }

    // Actualizar leyenda cuando se enciende/apaga una overlay
    map.on('overlayadd overlayremove', function(e) {
      updateLegend();
    });

    // ==========
    //  Cargar ZRC
    // ==========
    const geojsonUrl = "https://yalumeru.github.io/visor-leaflet/Zonas_de_Reserva_Campesina_Constituida.geojson";

    var allZrcData = null;

    fetch(geojsonUrl)
      .then(response => response.json())
      .then(data => {
        allZrcData = data;

        // Inicializar referencias a los selects
        deptoSelect = document.getElementById('filtro-depto');
        mpioSelect  = document.getElementById('filtro-mpio');

        // Llenar listas de valores √∫nicos
        rellenarFiltros(allZrcData);

        // Dibujar capa inicial sin filtros
        actualizarCapaZRC();

        // Eventos de cambio de filtro
        deptoSelect.addEventListener('change', function() {
          actualizarCapaZRC();
        });
        mpioSelect.addEventListener('change', function() {
          actualizarCapaZRC();
        });
      })
      .catch(err => console.error("Error cargando GeoJSON:", err));

    function getValoresUnicos(data, campo) {
      var set = new Set();
      if (!data || !data.features) return [];
      data.features.forEach(function(feat) {
        var props = feat.properties || {};
        var val = props[campo];
        if (val !== undefined && val !== null && val !== "") {
          set.add(String(val));
        }
      });
      return Array.from(set).sort();
    }

    function rellenarSelect(select, valores) {
      if (!select) return;
      // dejamos la opci√≥n "(Todos)" y agregamos el resto
      valores.forEach(function(v) {
        var opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        select.appendChild(opt);
      });
    }

    function rellenarFiltros(data) {
      var deptos = getValoresUnicos(data, FIELD_DEPTO);
      var mpios  = getValoresUnicos(data, FIELD_MPIO);

      rellenarSelect(deptoSelect, deptos);
      rellenarSelect(mpioSelect, mpios);
    }

    function actualizarCapaZRC() {
      if (!allZrcData) return;

      // Limpiar capa actual
      zrcLayer.clearLayers();

      var selDepto = deptoSelect ? deptoSelect.value : "__todos__";
      var selMpio  = mpioSelect  ? mpioSelect.value  : "__todos__";

      var hayFeatures = false;

      L.geoJSON(allZrcData, {
        filter: function(feature) {
          var props = feature.properties || {};
          var okDepto =
            selDepto === "__todos__" || String(props[FIELD_DEPTO]) === selDepto;
          var okMpio =
            selMpio === "__todos__" || String(props[FIELD_MPIO]) === selMpio;
          return okDepto && okMpio;
        },
        style: function(feature) {
          return {
            color: '#e31a1c',      // borde rojo
            weight: 2,
            fillColor: '#fb9a99',  // relleno rosado
            fillOpacity: 0.4
          };
        }
      }).eachLayer(function(layer) {
        hayFeatures = true;
        zrcLayer.addLayer(layer);
      });

      // Ajustar zoom si hay algo que mostrar
      if (hayFeatures) {
        try {
          map.fitBounds(zrcLayer.getBounds());
        } catch (e) {
          console.error("No se pudo ajustar el zoom:", e);
        }
      }

      // Actualizar leyenda seg√∫n si hay capa visible
      updateLegend();
    }
  </script>
</body>
</html>
